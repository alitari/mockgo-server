name: skaffold

on:
  push:
    branches: [ "ci-skaffold" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v3

    - name: Start Minikube
      id: minikube
      uses: hiberbee/github-action-minikube@1.7.0
    - name: Get Minikube IP
      run: echo "MINIKUBE_IP=${{ steps.minikube.outputs.ip }}" >> $GITHUB_ENV
    - name: Get cluster info
      run: kubectl cluster-info

    # - name: Get helm repositories
    #   uses: hiberbee/github-action-helm@1.13.0
    #   with:
    #     helm: repo list
    #     repository-config: test/repositories.yaml

    # - name: Login to Docker Hub
    #   uses: docker/login-action@v2
    #   with:
    #     username: alitari
    #     password: ${{ secrets.DOCKERHUB_TOKEN }}


    - name: Run Skaffold
      uses: hiberbee/github-action-skaffold@1.22.0
      with:
        command: run
    - name: Intergration test precheck
      run: ./scripts/integration-test-precheck.sh


